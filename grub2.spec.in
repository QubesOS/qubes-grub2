# This package calls binutils components directly and would need to pass
# in flags to enable the LTO plugins
# Disable LTO
%global _lto_cflags %{nil}

%undefine _hardened_build

%global tarversion @VERSION@
%undefine _missing_build_ids_terminate_build
%global _configure_gnuconfig_hack 0

%global efi_vendor qubes
%global efi_esp_dir /boot/efi/EFI/%{efi_vendor}
%global gnulibversion fixes

Name:		grub2
Epoch:		1000
Version:	@VERSION@
Release:	@REL@%{?dist}
Summary:	Bootloader with support for Linux, Multiboot and more
License:	GPLv3+
URL:		http://www.gnu.org/software/grub/
Obsoletes:	grub < 1:0.98
Source0:	https://ftp.gnu.org/gnu/grub/grub-%{tarversion}.tar.xz
Source1:	grub.macros
Source2:	gnulib-%{gnulibversion}.tar.gz
Source3:	99-grub-mkconfig.install
Source4:	http://unifoundry.com/unifont-5.1.20080820.pcf.gz
Source5:	theme.tar.bz2
Source6:	gitignore
Source7:	bootstrap
Source8:	bootstrap.conf
Source9:	strtoull_test.c
Source10:	20-grub.install
Source12:	sbat.csv.in

%include %{SOURCE1}

### begin grub.patches
Patch0: 0001-Revert-templates-Fix-user-facing-typo-with-an-incorr.patch
Patch1: 0002-Revert-templates-Properly-disable-the-os-prober-by-d.patch
Patch2: 0003-Revert-templates-Disable-the-os-prober-by-default.patch
Patch3: 0004-Add-support-for-Linux-EFI-stub-loading.patch
Patch4: 0005-Rework-linux-command.patch
Patch5: 0006-Rework-linux16-command.patch
Patch6: 0007-Add-secureboot-support-on-efi-chainloader.patch
Patch7: 0008-Make-any-of-the-loaders-that-link-in-efi-mode-honor-.patch
Patch8: 0009-Handle-multi-arch-64-on-32-boot-in-linuxefi-loader.patch
Patch9: 0010-re-write-.gitignore.patch
Patch10: 0011-IBM-client-architecture-CAS-reboot-support.patch
Patch11: 0012-for-ppc-reset-console-display-attr-when-clear-screen.patch
Patch12: 0013-Disable-GRUB-video-support-for-IBM-power-machines.patch
Patch13: 0014-Move-bash-completion-script-922997.patch
Patch14: 0015-Allow-fallback-to-include-entries-by-title-not-just-.patch
Patch15: 0016-Make-exit-take-a-return-code.patch
Patch16: 0017-Make-efi-machines-load-an-env-block-from-a-variable.patch
Patch17: 0018-Migrate-PPC-from-Yaboot-to-Grub2.patch
Patch18: 0019-Add-fw_path-variable-revised.patch
Patch19: 0020-Pass-x-hex-hex-straight-through-unmolested.patch
Patch20: 0021-blscfg-add-blscfg-module-to-parse-Boot-Loader-Specif.patch
Patch21: 0022-Add-devicetree-loading.patch
Patch22: 0023-Don-t-write-messages-to-the-screen.patch
Patch23: 0024-Don-t-print-GNU-GRUB-header.patch
Patch24: 0025-Don-t-add-to-highlighted-row.patch
Patch25: 0026-Message-string-cleanups.patch
Patch26: 0027-Fix-border-spacing-now-that-we-aren-t-displaying-it.patch
Patch27: 0028-Use-the-correct-indentation-for-the-term-help-text.patch
Patch28: 0029-Indent-menu-entries.patch
Patch29: 0030-Fix-margins.patch
Patch30: 0031-Use-2-instead-of-1-for-our-right-hand-margin-so-line.patch
Patch31: 0032-Enable-pager-by-default.-985860.patch
Patch32: 0033-F10-doesn-t-work-on-serial-so-don-t-tell-the-user-to.patch
Patch33: 0034-Don-t-say-GNU-Linux-in-generated-menus.patch
Patch34: 0035-Don-t-draw-a-border-around-the-menu.patch
Patch35: 0036-Use-the-standard-margin-for-the-timeout-string.patch
Patch36: 0037-Add-.eh_frame-to-list-of-relocations-stripped.patch
Patch37: 0038-Don-t-require-a-password-to-boot-entries-generated-b.patch
Patch38: 0039-Don-t-emit-Booting-.-message.patch
Patch39: 0040-Replace-a-lot-of-man-pages-with-slightly-nicer-ones.patch
Patch40: 0041-use-fw_path-prefix-when-fallback-searching-for-grub-.patch
Patch41: 0042-Try-mac-guid-etc-before-grub.cfg-on-tftp-config-file.patch
Patch42: 0043-Generate-OS-and-CLASS-in-10_linux-from-etc-os-releas.patch
Patch43: 0044-Minimize-the-sort-ordering-for-.debug-and-rescue-ker.patch
Patch44: 0045-Try-prefix-if-fw_path-doesn-t-work.patch
Patch45: 0046-Use-Distribution-Package-Sort-for-grub2-mkconfig-112.patch
Patch46: 0047-Make-grub2-mkconfig-construct-titles-that-look-like-.patch
Patch47: 0048-Add-friendly-grub2-password-config-tool-985962.patch
Patch48: 0049-tcp-add-window-scaling-support.patch
Patch49: 0050-efinet-and-bootp-add-support-for-dhcpv6.patch
Patch50: 0051-Add-grub-get-kernel-settings-and-use-it-in-10_linux.patch
Patch51: 0052-bz1374141-fix-incorrect-mask-for-ppc64.patch
Patch52: 0053-Make-grub_fatal-also-backtrace.patch
Patch53: 0054-Fix-up-some-man-pages-rpmdiff-noticed.patch
Patch54: 0055-Make-our-info-pages-say-grub2-where-appropriate.patch
Patch55: 0056-macos-just-build-chainloader-entries-don-t-try-any-x.patch
Patch56: 0057-grub2-btrfs-Add-ability-to-boot-from-subvolumes.patch
Patch57: 0058-export-btrfs_subvol-and-btrfs_subvolid.patch
Patch58: 0059-grub2-btrfs-03-follow_default.patch
Patch59: 0060-grub2-btrfs-04-grub2-install.patch
Patch60: 0061-grub2-btrfs-05-grub2-mkconfig.patch
Patch61: 0062-grub2-btrfs-06-subvol-mount.patch
Patch62: 0063-Fallback-to-old-subvol-name-scheme-to-support-old-sn.patch
Patch63: 0064-Grub-not-working-correctly-with-btrfs-snapshots-bsc-.patch
Patch64: 0065-Add-grub_efi_allocate_pool-and-grub_efi_free_pool-wr.patch
Patch65: 0066-Use-grub_efi_.-memory-helpers-where-reasonable.patch
Patch66: 0067-Add-PRIxGRUB_EFI_STATUS-and-use-it.patch
Patch67: 0068-don-t-use-int-for-efi-status.patch
Patch68: 0069-make-GRUB_MOD_INIT-declare-its-function-prototypes.patch
Patch69: 0070-Don-t-guess-boot-efi-as-HFS-on-ppc-machines-in-grub-.patch
Patch70: 0071-20_linux_xen-load-xen-or-multiboot-2-modules-as-need.patch
Patch71: 0072-Make-pmtimer-tsc-calibration-not-take-51-seconds-to-.patch
Patch72: 0073-align-struct-efi_variable-better.patch
Patch73: 0074-Add-BLS-support-to-grub-mkconfig.patch
Patch74: 0075-Don-t-attempt-to-backtrace-on-grub_abort-for-grub-em.patch
Patch75: 0076-Add-linux-and-initrd-commands-for-grub-emu.patch
Patch76: 0077-Add-grub2-switch-to-blscfg.patch
Patch77: 0078-make-better-backtraces.patch
Patch78: 0079-normal-don-t-draw-our-startup-message-if-debug-is-se.patch
Patch79: 0080-Work-around-some-minor-include-path-weirdnesses.patch
Patch80: 0081-Make-it-possible-to-enabled-build-id-sha1.patch
Patch81: 0082-Add-grub_qdprintf-grub_dprintf-without-the-file-line.patch
Patch82: 0083-Make-a-gdb-dprintf-that-tells-us-load-addresses.patch
Patch83: 0084-Fixup-for-newer-compiler.patch
Patch84: 0085-Don-t-attempt-to-export-the-start-and-_start-symbols.patch
Patch85: 0086-Fixup-for-newer-compiler.patch
Patch86: 0087-Add-support-for-non-Ethernet-network-cards.patch
Patch87: 0088-net-read-bracketed-ipv6-addrs-and-port-numbers.patch
Patch88: 0089-bootp-New-net_bootp6-command.patch
Patch89: 0090-efinet-UEFI-IPv6-PXE-support.patch
Patch90: 0091-grub.texi-Add-net_bootp6-doument.patch
Patch91: 0092-bootp-Add-processing-DHCPACK-packet-from-HTTP-Boot.patch
Patch92: 0093-efinet-Setting-network-from-UEFI-device-path.patch
Patch93: 0094-efinet-Setting-DNS-server-from-UEFI-protocol.patch
Patch94: 0095-Support-UEFI-networking-protocols.patch
Patch95: 0096-AUDIT-0-http-boot-tracker-bug.patch
Patch96: 0097-grub-editenv-Add-incr-command-to-increment-integer-v.patch
Patch97: 0098-Add-auto-hide-menu-support.patch
Patch98: 0099-Add-grub-set-bootflag-utility.patch
Patch99: 0100-docs-Add-grub-boot-indeterminate.service-example.patch
Patch100: 0101-gentpl-add-disable-support.patch
Patch101: 0102-gentpl-add-pc-firmware-type.patch
Patch102: 0103-efinet-also-use-the-firmware-acceleration-for-http.patch
Patch103: 0104-efi-http-Make-root_url-reflect-the-protocol-hostname.patch
Patch104: 0105-Make-it-so-we-can-tell-configure-which-cflags-utils-.patch
Patch105: 0106-module-verifier-make-it-possible-to-run-checkers-on-.patch
Patch106: 0107-Rework-how-the-fdt-command-builds.patch
Patch107: 0108-Disable-non-wordsize-allocations-on-arm.patch
Patch108: 0109-Prepend-prefix-when-HTTP-path-is-relative.patch
Patch109: 0110-Make-grub_error-more-verbose.patch
Patch110: 0111-Make-reset-an-alias-for-the-reboot-command.patch
Patch111: 0112-Add-a-version-command.patch
Patch112: 0113-Add-more-dprintf-and-nerf-dprintf-in-script.c.patch
Patch113: 0114-arm-arm64-loader-Better-memory-allocation-and-error-.patch
Patch114: 0115-Try-to-pick-better-locations-for-kernel-and-initrd.patch
Patch115: 0116-Attempt-to-fix-up-all-the-places-Wsign-compare-error.patch
Patch116: 0117-Don-t-use-Wno-sign-compare-Wno-conversion-Wno-error-.patch
Patch117: 0118-x86-efi-Use-bounce-buffers-for-reading-to-addresses-.patch
Patch118: 0119-x86-efi-Re-arrange-grub_cmd_linux-a-little-bit.patch
Patch119: 0120-x86-efi-Make-our-own-allocator-for-kernel-stuff.patch
Patch120: 0121-x86-efi-Allow-initrd-params-cmdline-allocations-abov.patch
Patch121: 0122-Fix-getroot.c-s-trampolines.patch
Patch122: 0123-Do-not-allow-stack-trampolines-anywhere.patch
Patch123: 0124-Reimplement-boot_counter.patch
Patch124: 0125-Fix-menu-entry-selection-based-on-ID-and-title.patch
Patch125: 0126-Make-the-menu-entry-users-option-argument-to-be-opti.patch
Patch126: 0127-Add-efi-export-env-and-efi-load-env-commands.patch
Patch127: 0128-Make-it-possible-to-subtract-conditions-from-debug.patch
Patch128: 0129-Export-all-variables-from-the-initial-context-when-c.patch
Patch129: 0130-grub.d-Split-out-boot-success-reset-from-menu-auto-h.patch
Patch130: 0131-Fix-systemctl-kexec-exit-status-check.patch
Patch131: 0132-Print-grub-emu-linux-loader-messages-as-debug.patch
Patch132: 0133-Don-t-assume-that-boot-commands-will-only-return-on-.patch
Patch133: 0134-Fix-undefined-references-for-fdt-when-building-with-.patch
Patch134: 0135-Do-better-in-bootstrap.conf.patch
Patch135: 0136-Use-git-to-apply-gnulib-patches.patch
Patch136: 0137-Fix-build-error-with-the-fdt-module-on-risc-v.patch
Patch137: 0138-grub-set-bootflag-Update-comment-about-running-as-ro.patch
Patch138: 0139-grub-set-bootflag-Write-new-env-to-tmpfile-and-then-.patch
Patch139: 0140-grub.d-Fix-boot_indeterminate-getting-set-on-boot_su.patch
Patch140: 0141-Also-define-GRUB_EFI_MAX_ALLOCATION_ADDRESS-for-RISC.patch
Patch141: 0142-chainloader-Define-machine-types-for-RISC-V.patch
Patch142: 0143-Add-start-symbol-for-RISC-V.patch
Patch143: 0144-bootstrap.conf-Force-autogen.sh-to-use-python3.patch
Patch144: 0145-efi-http-Export-fw-http-_path-variables-to-make-them.patch
Patch145: 0146-efi-http-Enclose-literal-IPv6-addresses-in-square-br.patch
Patch146: 0147-efi-net-Allow-to-specify-a-port-number-in-addresses.patch
Patch147: 0148-efi-ip4_config-Improve-check-to-detect-literal-IPv6-.patch
Patch148: 0149-efi-net-Print-a-debug-message-if-parsing-the-address.patch
Patch149: 0150-kern-term-Also-accept-F8-as-a-user-interrupt-key.patch
Patch150: 0151-efi-Set-image-base-address-before-jumping-to-the-PE-.patch
Patch151: 0152-tpm-Don-t-propagate-TPM-measurement-errors-to-the-ve.patch
Patch152: 0153-x86-efi-Reduce-maximum-bounce-buffer-size-to-16-MiB.patch
Patch153: 0154-http-Prepend-prefix-when-the-HTTP-path-is-relative-a.patch
Patch154: 0155-Fix-a-missing-return-in-efi-export-env-and-efi-load-.patch
Patch155: 0156-efi-dhcp-fix-some-allocation-error-checking.patch
Patch156: 0157-efi-http-fix-some-allocation-error-checking.patch
Patch157: 0158-efi-ip-46-_config.c-fix-some-potential-allocation-ov.patch
Patch158: 0159-efilinux-Fix-integer-overflows-in-grub_cmd_initrd.patch
Patch159: 0160-linuxefi-fail-kernel-validation-without-shim-protoco.patch
Patch160: 0161-Fix-const-char-pointers-in-grub-core-net-bootp.c.patch
Patch161: 0162-Fix-const-char-pointers-in-grub-core-net-efi-ip4_con.patch
Patch162: 0163-Fix-const-char-pointers-in-grub-core-net-efi-ip6_con.patch
Patch163: 0164-Fix-const-char-pointers-in-grub-core-net-efi-net.c.patch
Patch164: 0165-Fix-const-char-pointers-in-grub-core-net-efi-pxe.c.patch
Patch165: 0166-Add-systemd-integration-scripts-to-make-systemctl-re.patch
Patch166: 0167-systemd-integration.sh-Also-set-old-menu_show_once-g.patch
Patch167: 0168-at_keyboard-use-set-1-when-keyboard-is-in-Translate-.patch
Patch168: 0169-grub-install-disable-support-for-EFI-platforms.patch
Patch169: 0170-New-with-debug-timestamps-configure-flag-to-prepend-.patch
Patch170: 0171-Added-debug-statements-to-grub_disk_open-and-grub_di.patch
Patch171: 0172-Introduce-function-grub_debug_is_enabled-void-return.patch
Patch172: 0173-Don-t-clear-screen-when-debugging-is-enabled.patch
Patch173: 0174-grub_file_-instrumentation-new-file-debug-tag.patch
Patch174: 0175-ieee1275-Avoiding-many-unecessary-open-close.patch
Patch175: 0176-ieee1275-powerpc-implements-fibre-channel-discovery-.patch
Patch176: 0177-ieee1275-powerpc-enables-device-mapper-discovery.patch
Patch177: 0178-Add-at_keyboard_fallback_set-var-to-force-the-set-ma.patch
Patch178: 0179-Add-suport-for-signing-grub-with-an-appended-signatu.patch
Patch179: 0180-docs-grub-Document-signing-grub-under-UEFI.patch
Patch180: 0181-docs-grub-Document-signing-grub-with-an-appended-sig.patch
Patch181: 0182-dl-provide-a-fake-grub_dl_set_persistent-for-the-emu.patch
Patch182: 0183-pgp-factor-out-rsa_pad.patch
Patch183: 0184-crypto-move-storage-for-grub_crypto_pk_-to-crypto.c.patch
Patch184: 0185-posix_wrap-tweaks-in-preparation-for-libtasn1.patch
Patch185: 0186-libtasn1-import-libtasn1-4.16.0.patch
Patch186: 0187-libtasn1-disable-code-not-needed-in-grub.patch
Patch187: 0188-libtasn1-changes-for-grub-compatibility.patch
Patch188: 0189-libtasn1-compile-into-asn1-module.patch
Patch189: 0190-test_asn1-test-module-for-libtasn1.patch
Patch190: 0191-grub-install-support-embedding-x509-certificates.patch
Patch191: 0192-appended-signatures-import-GNUTLS-s-ASN.1-descriptio.patch
Patch192: 0193-appended-signatures-parse-PKCS-7-signedData-and-X.50.patch
Patch193: 0194-appended-signatures-support-verifying-appended-signa.patch
Patch194: 0195-appended-signatures-verification-tests.patch
Patch195: 0196-appended-signatures-documentation.patch
Patch196: 0197-ieee1275-enter-lockdown-based-on-ibm-secure-boot.patch
Patch197: 0198-ieee1275-drop-HEAP_MAX_ADDR-HEAP_MIN_SIZE.patch
Patch198: 0199-ieee1275-claim-more-memory.patch
Patch199: 0200-ieee1275-request-memory-with-ibm-client-architecture.patch
Patch200: 0201-appendedsig-x509-Also-handle-the-Extended-Key-Usage-.patch
Patch201: 0202-ieee1275-ofdisk-retry-on-open-failure.patch
Patch202: 0203-01_menu_auto_hide.in-fix-a-then-than-typo.patch
Patch203: 0204-Fix-disabling-grub-rpm-sort.patch
Patch204: 0205-Don-t-check-for-rpmvercmp-in-librpm.patch
Patch205: 0206-Allow-chainloading-EFI-apps-from-loop-mounts.patch
Patch206: 0207-efinet-Add-DHCP-proxy-support.patch
Patch207: 0208-fs-ext2-Ignore-checksum-seed-incompat-feature.patch
Patch208: 0209-Don-t-update-the-cmdline-when-generating-legacy-menu.patch
Patch209: 0210-Suppress-gettext-error-message.patch
Patch210: 0211-grub-boot-success.timer-Only-run-if-not-in-a-contain.patch
Patch211: 0212-grub-set-password-Always-use-boot-grub2-user.cfg-as-.patch
Patch212: 0213-Remove-outdated-URL-for-BLS-document.patch
Patch213: 0214-templates-Check-for-EFI-at-runtime-instead-of-config.patch
Patch214: 0215-efi-Print-an-error-if-boot-to-firmware-setup-is-not-.patch
Patch215: 0216-arm64-Fix-EFI-loader-kernel-image-allocation.patch
Patch216: 0217-normal-main-Discover-the-device-to-read-the-config-f.patch
Patch217: 0218-powerpc-adjust-setting-of-prefix-for-signed-binary-c.patch
Patch218: 0219-powerpc-fix-prefix-signed-grub-special-case-for-Powe.patch
Patch219: 0220-Arm-check-for-the-PE-magic-for-the-compiled-arch.patch
Patch220: 0221-fs-xfs-Fix-unreadable-filesystem-with-v4-superblock.patch
### end grub.patches


BuildRequires:	gcc efi-srpm-macros
BuildRequires:	flex bison binutils python3
BuildRequires:	ncurses-devel xz-devel bzip2-devel
BuildRequires:	freetype-devel libusb-devel
BuildRequires:	fuse-devel
BuildRequires:	rpm-devel rpm-libs
BuildRequires:	autoconf automake device-mapper-devel
BuildRequires:	freetype-devel gettext-devel git
BuildRequires:	texinfo
BuildRequires:	dejavu-sans-fonts
BuildRequires:	help2man
# For %%_userunitdir macro
BuildRequires:	systemd
%ifarch %{efi_arch}
BuildRequires:	pesign >= 0.99-8
%endif
%if %{?_with_ccache: 1}%{?!_with_ccache: 0}
BuildRequires:	ccache
%endif

ExcludeArch:	s390 s390x
Obsoletes:	%{name} <= %{evr}

%if 0%{with_legacy_arch}
Requires:	%{name}-%{legacy_package_arch} = %{evr}
%else
Requires:	%{name}-%{package_arch} = %{evr}
%endif

%global desc \
The GRand Unified Bootloader (GRUB) is a highly configurable and \
customizable bootloader with modular architecture.  It supports a rich \
variety of kernel formats, file systems, computer architectures and \
hardware devices.\
%{nil}

%description
%{desc}

%package common
Summary:	grub2 common layout
BuildArch:	noarch
Conflicts:	grubby < 8.40-18
Requires(post): util-linux

%description common
This package provides some directories which are required by various grub2
subpackages.

%package tools
Summary:	Support tools for GRUB.
Obsoletes:	%{name}-tools < %{evr}
Requires:	%{name}-common = %{epoch}:%{version}-%{release}
Requires:	gettext os-prober which file
Requires(pre):	dracut
Requires(post):	dracut

%description tools
%{desc}
This subpackage provides tools for support of all platforms.

%ifarch x86_64
%package tools-efi
Summary:	Support tools for GRUB.
Requires:	gettext os-prober which file
Requires:	%{name}-common = %{epoch}:%{version}-%{release}
Obsoletes:	%{name}-tools < %{evr}

%description tools-efi
%{desc}
This subpackage provides tools for support of EFI platforms.
%endif

%package tools-minimal
Summary:	Support tools for GRUB.
Requires:	gettext
Requires:	%{name}-common = %{epoch}:%{version}-%{release}
Obsoletes:	%{name}-tools < %{evr}

%description tools-minimal
%{desc}
This subpackage provides tools for support of all platforms.

%package tools-extra
Summary:	Support tools for GRUB.
Requires:	gettext os-prober which file
Requires:	%{name}-tools-minimal = %{epoch}:%{version}-%{release}
Requires:	%{name}-common = %{epoch}:%{version}-%{release}
Obsoletes:	%{name}-tools < %{evr}

%description tools-extra
%{desc}
This subpackage provides tools for support of all platforms.

%if 0%{with_efi_arch}
%{expand:%define_efi_variant %%{package_arch} -o}
%endif
%if 0%{with_alt_efi_arch}
%{expand:%define_efi_variant %%{alt_package_arch}}
%endif
%if 0%{with_legacy_arch}
%{expand:%define_legacy_variant %%{legacy_package_arch}}
%endif

%if 0%{with_emu_arch}
%package emu
Summary:	GRUB user-space emulation.
Requires:	%{name}-tools-minimal = %{epoch}:%{version}-%{release}

%description emu
%{desc}
This subpackage provides the GRUB user-space emulation support of all platforms.

%package emu-modules
Summary:	GRUB user-space emulation modules.
Requires:	%{name}-tools-minimal = %{epoch}:%{version}-%{release}

%description emu-modules
%{desc}
This subpackage provides the GRUB user-space emulation modules.
%endif

%prep
%do_common_setup
%if 0%{with_efi_arch}
mkdir grub-%{grubefiarch}-%{tarversion}
grep -A100000 '# stuff "make" creates' .gitignore > grub-%{grubefiarch}-%{tarversion}/.gitignore
cp %{SOURCE4} grub-%{grubefiarch}-%{tarversion}/unifont.pcf.gz
sed -e "s,@@VERSION@@,%{version},g" -e "s,@@VERSION_RELEASE@@,%{version}-%{release},g" \
    %{SOURCE12} > grub-%{grubefiarch}-%{tarversion}/sbat.csv
git add grub-%{grubefiarch}-%{tarversion}
%endif
%if 0%{with_alt_efi_arch}
mkdir grub-%{grubaltefiarch}-%{tarversion}
grep -A100000 '# stuff "make" creates' .gitignore > grub-%{grubaltefiarch}-%{tarversion}/.gitignore
cp %{SOURCE4} grub-%{grubaltefiarch}-%{tarversion}/unifont.pcf.gz
git add grub-%{grubaltefiarch}-%{tarversion}
%endif
%if 0%{with_legacy_arch}
mkdir grub-%{grublegacyarch}-%{tarversion}
grep -A100000 '# stuff "make" creates' .gitignore > grub-%{grublegacyarch}-%{tarversion}/.gitignore
cp %{SOURCE4} grub-%{grublegacyarch}-%{tarversion}/unifont.pcf.gz
git add grub-%{grublegacyarch}-%{tarversion}
%endif
%if 0%{with_emu_arch}
mkdir grub-emu-%{tarversion}
grep -A100000 '# stuff "make" creates' .gitignore > grub-emu-%{tarversion}/.gitignore
cp %{SOURCE4} grub-emu-%{tarversion}/unifont.pcf.gz
git add grub-emu-%{tarversion}
%endif
git commit -m "After making subdirs"

%build
%if 0%{with_efi_arch}
%{expand:%do_primary_efi_build %%{grubefiarch} %%{grubefiname} %%{grubeficdname} %%{_target_platform} %%{efi_target_cflags} %%{efi_host_cflags}}
%endif
%if 0%{with_alt_efi_arch}
%{expand:%do_alt_efi_build %%{grubaltefiarch} %%{grubaltefiname} %%{grubalteficdname} %%{_alt_target_platform} %%{alt_efi_target_cflags} %%{alt_efi_host_cflags}}
%endif
%if 0%{with_legacy_arch}
%{expand:%do_legacy_build %%{grublegacyarch}}
%endif
%if 0%{with_emu_arch}
%{expand:%do_emu_build}
%endif
makeinfo --info --no-split -I docs -o docs/grub-dev.info \
	docs/grub-dev.texi
makeinfo --info --no-split -I docs -o docs/grub.info \
	docs/grub.texi
makeinfo --html --no-split -I docs -o docs/grub-dev.html \
	docs/grub-dev.texi
makeinfo --html --no-split -I docs -o docs/grub.html \
	docs/grub.texi

%install
set -e
rm -fr $RPM_BUILD_ROOT

%do_common_install
%if 0%{with_efi_arch}
%{expand:%do_efi_install %%{grubefiarch} %%{grubefiname} %%{grubeficdname}}
%endif
%if 0%{with_alt_efi_arch}
%{expand:%do_alt_efi_install %%{grubaltefiarch} %%{grubaltefiname} %%{grubalteficdname}}
%endif
%if 0%{with_legacy_arch}
%{expand:%do_legacy_install %%{grublegacyarch} %%{alt_grub_target_name} 0%{with_efi_arch}}
%endif
%if 0%{with_emu_arch}
%{expand:%do_emu_install %%{package_arch}}
%endif
rm -f $RPM_BUILD_ROOT%{_infodir}/dir
ln -s %{name}-set-password ${RPM_BUILD_ROOT}/%{_sbindir}/%{name}-setpassword
echo '.so man8/%{name}-set-password.8' > ${RPM_BUILD_ROOT}/%{_datadir}/man/man8/%{name}-setpassword.8
%ifnarch x86_64
rm -vf ${RPM_BUILD_ROOT}/%{_bindir}/%{name}-render-label
rm -vf ${RPM_BUILD_ROOT}/%{_sbindir}/%{name}-bios-setup
rm -vf ${RPM_BUILD_ROOT}/%{_sbindir}/%{name}-macbless
%endif
%{expand:%%do_install_protected_file %{name}-tools-minimal}

%find_lang grub

# Make selinux happy with exec stack binaries.
mkdir ${RPM_BUILD_ROOT}%{_sysconfdir}/prelink.conf.d/
cat << EOF > ${RPM_BUILD_ROOT}%{_sysconfdir}/prelink.conf.d/grub2.conf
# these have execstack, and break under selinux
-b /usr/bin/grub2-script-check
-b /usr/bin/grub2-mkrelpath
-b /usr/bin/grub2-mount
-b /usr/bin/grub2-fstest
-b /usr/sbin/grub2-bios-setup
-b /usr/sbin/grub2-probe
-b /usr/sbin/grub2-sparc64-setup
EOF

# Install kernel-install scripts
install -d -m 0755 %{buildroot}%{_prefix}/lib/kernel/install.d/
install -D -m 0755 -t %{buildroot}%{_prefix}/lib/kernel/install.d/ %{SOURCE10}
install -D -m 0755 -t %{buildroot}%{_prefix}/lib/kernel/install.d/ %{SOURCE3}
install -d -m 0755 %{buildroot}%{_sysconfdir}/kernel/install.d/
# Install systemd user service to set the boot_success flag
install -D -m 0755 -t %{buildroot}%{_userunitdir} \
	docs/grub-boot-success.{timer,service}
install -d -m 0755 %{buildroot}%{_userunitdir}/timers.target.wants
ln -s ../grub-boot-success.timer \
	%{buildroot}%{_userunitdir}/timers.target.wants
# Install systemd system-update unit to set boot_indeterminate for offline-upd
install -D -m 0755 -t %{buildroot}%{_unitdir} docs/grub-boot-indeterminate.service
install -d -m 0755 %{buildroot}%{_unitdir}/system-update.target.wants
install -d -m 0755 %{buildroot}%{_unitdir}/reboot.target.wants
ln -s ../grub-boot-indeterminate.service \
	%{buildroot}%{_unitdir}/system-update.target.wants
ln -s ../%{name}-systemd-integration.service \
	%{buildroot}%{_unitdir}/reboot.target.wants

# Don't run debuginfo on all the grub modules and whatnot; it just
# rejects them, complains, and slows down extraction.
%global finddebugroot "%{_builddir}/%{?buildsubdir}/debug"

%global dip RPM_BUILD_ROOT=%{finddebugroot} %{__debug_install_post}
%define __debug_install_post (						\
	mkdir -p %{finddebugroot}/usr					\
	mv ${RPM_BUILD_ROOT}/usr/bin %{finddebugroot}/usr/bin		\
	mv ${RPM_BUILD_ROOT}/usr/sbin %{finddebugroot}/usr/sbin		\
	%{dip}								\
	install -m 0755 -d %{buildroot}/usr/lib/ %{buildroot}/usr/src/	\
	cp -al %{finddebugroot}/usr/lib/debug/				\\\
		%{buildroot}/usr/lib/debug/				\
	cp -al %{finddebugroot}/usr/src/debug/				\\\
		%{buildroot}/usr/src/debug/ )				\
	mv %{finddebugroot}/usr/bin %{buildroot}/usr/bin		\
	mv %{finddebugroot}/usr/sbin %{buildroot}/usr/sbin		\
	%{nil}

%undefine buildsubdir

%pre tools
if [ -f /boot/%{name}/user.cfg ]; then
    if grep -q '^GRUB_PASSWORD=' /boot/%{name}/user.cfg ; then
	sed -i 's/^GRUB_PASSWORD=/GRUB2_PASSWORD=/' /boot/%{name}/user.cfg
    fi
elif [ -f %{efi_esp_dir}/user.cfg ]; then
    if grep -q '^GRUB_PASSWORD=' %{efi_esp_dir}/user.cfg ; then
	sed -i 's/^GRUB_PASSWORD=/GRUB2_PASSWORD=/' \
	    %{efi_esp_dir}/user.cfg
    fi
elif [ -f /etc/grub.d/01_users ] && \
	grep -q '^password_pbkdf2 root' /etc/grub.d/01_users ; then
    if [ -f %{efi_esp_dir}/grub.cfg ]; then
	# on EFI we don't get permissions on the file, but
	# the directory is protected.
	grep '^password_pbkdf2 root' /etc/grub.d/01_users | \
		sed 's/^password_pbkdf2 root \(.*\)$/GRUB2_PASSWORD=\1/' \
	    > %{efi_esp_dir}/user.cfg
    fi
    if [ -f /boot/%{name}/grub.cfg ]; then
	install -m 0600 /dev/null /boot/%{name}/user.cfg
	chmod 0600 /boot/%{name}/user.cfg
	grep '^password_pbkdf2 root' /etc/grub.d/01_users | \
		sed 's/^password_pbkdf2 root \(.*\)$/GRUB2_PASSWORD=\1/' \
	    > /boot/%{name}/user.cfg
    fi
fi

%triggerun -- grub2 < 1:1.99-4
# grub2 < 1.99-4 removed a number of essential files in postun. To fix upgrades
# from the affected grub2 packages, we first back up the files in triggerun and
# later restore them in triggerpostun.
# https://bugzilla.redhat.com/show_bug.cgi?id=735259

# Back up the files before uninstalling old grub2
mkdir -p /boot/grub2.tmp &&
mv -f /boot/grub2/*.mod \
      /boot/grub2/*.img \
      /boot/grub2/*.lst \
      /boot/grub2/device.map \
      /boot/grub2.tmp/ || :

%triggerpostun -- grub2 < 1:1.99-4
# ... and restore the files.
test ! -f /boot/grub2/device.map &&
test -d /boot/grub2.tmp &&
mv -f /boot/grub2.tmp/*.mod \
      /boot/grub2.tmp/*.img \
      /boot/grub2.tmp/*.lst \
      /boot/grub2.tmp/device.map \
      /boot/grub2/ &&
rm -r /boot/grub2.tmp/ || :

%posttrans common
set -eu

EFI_HOME=%{efi_esp_dir}
GRUB_HOME=/boot/%{name}
ESP_PATH=/boot/efi

if ! mountpoint -q ${ESP_PATH}; then
    exit 0 # no ESP mounted, nothing to do
fi

if test ! -f ${EFI_HOME}/grub.cfg; then
    # there's no config in ESP, create one
    grub2-mkconfig -o ${EFI_HOME}/grub.cfg
fi

if grep -q "configfile" ${EFI_HOME}/grub.cfg; then
    exit 0 # already unified, nothing to do
fi

# create a stub grub2 config in EFI
BOOT_UUID=$(%{name}-probe --target=fs_uuid ${GRUB_HOME})
GRUB_DIR=$(%{name}-mkrelpath ${GRUB_HOME})

cat << EOF > ${EFI_HOME}/grub.cfg.stb
search --no-floppy --fs-uuid --set=dev ${BOOT_UUID}
set prefix=(\$dev)${GRUB_DIR}
export \$prefix
configfile \$prefix/grub.cfg
EOF

if test -f ${EFI_HOME}/grubenv; then
    cp -a ${EFI_HOME}/grubenv ${EFI_HOME}/grubenv.rpmsave
    mv --force ${EFI_HOME}/grubenv ${GRUB_HOME}/grubenv
fi

cp -a ${EFI_HOME}/grub.cfg ${EFI_HOME}/grub.cfg.rpmsave
cp -a ${EFI_HOME}/grub.cfg ${GRUB_HOME}/
mv ${EFI_HOME}/grub.cfg.stb ${EFI_HOME}/grub.cfg

%files common -f grub.lang
%dir %{_libdir}/grub/
%dir %{_datarootdir}/grub/
%attr(0700,root,root) %dir %{_sysconfdir}/grub.d
%{_prefix}/lib/kernel/install.d/20-grub.install
%{_prefix}/lib/kernel/install.d/99-grub-mkconfig.install
%dir %{_datarootdir}/grub
%exclude %{_datarootdir}/grub/*
%dir /boot/%{name}
%dir /boot/%{name}/themes/
%dir /boot/%{name}/themes/system
%attr(0700,root,root) %dir /boot/%{name}
%exclude /boot/%{name}/*
%dir %attr(0700,root,root) %{efi_esp_dir}
%exclude %{efi_esp_dir}/*
%ghost %config(noreplace) %verify(not size mode md5 mtime) /boot/%{name}/grubenv
%license COPYING
%doc THANKS
%doc docs/grub.html
%doc docs/grub-dev.html
%doc docs/font_char_metrics.png

%files tools-minimal
%{_sysconfdir}/prelink.conf.d/grub2.conf
%{_sbindir}/%{name}-get-kernel-settings
%{_sbindir}/%{name}-probe
%attr(4755, root, root) %{_sbindir}/%{name}-set-bootflag
%{_sbindir}/%{name}-set-default
%{_sbindir}/%{name}-set*password
%{_bindir}/%{name}-editenv
%{_bindir}/%{name}-mkpasswd-pbkdf2
%{_bindir}/%{name}-mount
%attr(0644,root,root) %config(noreplace) /etc/dnf/protected.d/%{name}-tools-minimal.conf

%{_datadir}/man/man3/%{name}-get-kernel-settings*
%{_datadir}/man/man8/%{name}-set-default*
%{_datadir}/man/man8/%{name}-set*password*
%{_datadir}/man/man1/%{name}-editenv*
%{_datadir}/man/man1/%{name}-mkpasswd-*

%ifarch x86_64
%files tools-efi
%{_bindir}/%{name}-glue-efi
%{_bindir}/%{name}-render-label
%{_sbindir}/%{name}-macbless
%{_datadir}/man/man1/%{name}-glue-efi*
%{_datadir}/man/man1/%{name}-render-label*
%{_datadir}/man/man8/%{name}-macbless*
%endif

%files tools
%attr(0644,root,root) %ghost %config(noreplace) %{_sysconfdir}/default/grub
%config %{_sysconfdir}/grub.d/??_*
%{_sysconfdir}/grub.d/README
%{_userunitdir}/grub-boot-success.timer
%{_userunitdir}/grub-boot-success.service
%{_userunitdir}/timers.target.wants
%{_unitdir}/grub-boot-indeterminate.service
%{_unitdir}/system-update.target.wants
%{_unitdir}/%{name}-systemd-integration.service
%{_unitdir}/reboot.target.wants
%{_unitdir}/systemd-logind.service.d
%{_infodir}/%{name}*
%{_datarootdir}/grub/*
%{_sbindir}/%{name}-install
%exclude %{_datarootdir}/grub/themes
%exclude %{_datarootdir}/grub/*.h
%{_datarootdir}/bash-completion/completions/grub
%{_sbindir}/%{name}-mkconfig
%{_sbindir}/%{name}-switch-to-blscfg
%{_sbindir}/%{name}-rpm-sort
%{_sbindir}/%{name}-reboot
%{_bindir}/%{name}-file
%{_bindir}/%{name}-menulst2cfg
%{_bindir}/%{name}-mkimage
%{_bindir}/%{name}-mkrelpath
%{_bindir}/%{name}-script-check
%{_libexecdir}/%{name}
%{_datadir}/man/man?/*

# exclude man pages from tools-extra
%exclude %{_datadir}/man/man8/%{name}-sparc64-setup*
%exclude %{_datadir}/man/man1/%{name}-fstest*
%exclude %{_datadir}/man/man1/%{name}-glue-efi*
%exclude %{_datadir}/man/man1/%{name}-kbdcomp*
%exclude %{_datadir}/man/man1/%{name}-mkfont*
%exclude %{_datadir}/man/man1/%{name}-mklayout*
%exclude %{_datadir}/man/man1/%{name}-mknetdir*
%exclude %{_datadir}/man/man1/%{name}-mkrescue*
%exclude %{_datadir}/man/man1/%{name}-mkstandalone*
%exclude %{_datadir}/man/man1/%{name}-syslinux2cfg*

# exclude man pages from tools-minimal
%exclude %{_datadir}/man/man3/%{name}-get-kernel-settings*
%exclude %{_datadir}/man/man8/%{name}-set-default*
%exclude %{_datadir}/man/man8/%{name}-set*password*
%exclude %{_datadir}/man/man1/%{name}-editenv*
%exclude %{_datadir}/man/man1/%{name}-mkpasswd-*
%exclude %{_datadir}/man/man8/%{name}-macbless*
%exclude %{_datadir}/man/man1/%{name}-render-label*

%if %{with_legacy_arch}
%{_sbindir}/%{name}-install
%ifarch x86_64
%{_sbindir}/%{name}-bios-setup
%else
%exclude %{_sbindir}/%{name}-bios-setup
%exclude %{_datadir}/man/man8/%{name}-bios-setup*
%endif
%ifarch %{sparc}
%{_sbindir}/%{name}-sparc64-setup
%else
%exclude %{_sbindir}/%{name}-sparc64-setup
%exclude %{_datadir}/man/man8/%{name}-sparc64-setup*
%endif
%ifarch %{sparc} ppc ppc64 ppc64le
%{_sbindir}/%{name}-ofpathname
%else
%exclude %{_sbindir}/%{name}-ofpathname
%exclude %{_datadir}/man/man8/%{name}-ofpathname*
%endif
%endif

%files tools-extra
%{_bindir}/%{name}-fstest
%{_bindir}/%{name}-kbdcomp
%{_bindir}/%{name}-mkfont
%{_bindir}/%{name}-mklayout
%{_bindir}/%{name}-mknetdir
%ifnarch %{sparc}
%{_bindir}/%{name}-mkrescue
%{_datadir}/man/man1/%{name}-mkrescue*
%else
%exclude %{_datadir}/man/man1/%{name}-mkrescue*
%endif
%{_bindir}/%{name}-mkstandalone
%{_bindir}/%{name}-syslinux2cfg
%{_sysconfdir}/sysconfig/grub
%{_datadir}/man/man1/%{name}-fstest*
%{_datadir}/man/man1/%{name}-kbdcomp*
%{_datadir}/man/man1/%{name}-mkfont*
%{_datadir}/man/man1/%{name}-mklayout*
%{_datadir}/man/man1/%{name}-mknetdir*
%{_datadir}/man/man1/%{name}-mkstandalone*
%{_datadir}/man/man1/%{name}-syslinux2cfg*
%exclude %{_bindir}/%{name}-glue-efi
%exclude %{_sbindir}/%{name}-sparc64-setup
%exclude %{_sbindir}/%{name}-ofpathname
%exclude %{_datadir}/man/man1/%{name}-glue-efi*
%exclude %{_datadir}/man/man8/%{name}-ofpathname*
%exclude %{_datadir}/man/man8/%{name}-sparc64-setup*
%exclude %{_datarootdir}/grub/themes/starfield

%if 0%{with_efi_arch}
%{expand:%define_efi_variant_files %%{package_arch} %%{grubefiname} %%{grubeficdname} %%{grubefiarch} %%{target_cpu_name} %%{grub_target_name}}
%endif
%if 0%{with_alt_efi_arch}
%{expand:%define_efi_variant_files %%{alt_package_arch} %%{grubaltefiname} %%{grubalteficdname} %%{grubaltefiarch} %%{alt_target_cpu_name} %%{alt_grub_target_name}}
%endif
%if 0%{with_legacy_arch}
%{expand:%define_legacy_variant_files %%{legacy_package_arch} %%{grublegacyarch}}
%endif

%if 0%{with_emu_arch}
%files emu
%{_bindir}/%{name}-emu*
%{_datadir}/man/man1/%{name}-emu*

%files emu-modules
%{_libdir}/grub/%{emuarch}-emu/*
%exclude %{_libdir}/grub/%{emuarch}-emu/*.module
%endif

%changelog
@CHANGELOG@
